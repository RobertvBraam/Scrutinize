using System.Runtime.InteropServices;
using Domain;
using Domain.Results;
using Domain.Vulnerabilities;
using Npm = Scanning.Npm.Vulnerabilities;
using Nuget = Scanning.Nuget.Vulnerabilities;

namespace Host.Console;

public class VulnerabilityFactory
{
    public static Result<IVulnerabilities> Create(string path)
    {
        if (!Directory.Exists(path))
        {
            return Result<IVulnerabilities>.Failed(IncorrectPathFailed.Create(path));
        }

        var isWindows = RuntimeInformation.IsOSPlatform(OSPlatform.Windows);
        
        if (Directory.GetFiles(path).Any(x => x.EndsWith(".csproj") || x.EndsWith(".sln")))
        {
            return Result<IVulnerabilities>.Succeeded(new Nuget.VulnerabilityScanning(isWindows));
        }
        
        if (path.EndsWith("package.json"))
        {
            return Result<IVulnerabilities>.Succeeded(new Npm.VulnerabilityScanning(isWindows, new Logger<Npm.VulnerabilityScanning>()));
        }

        return Result<IVulnerabilities>.Failed(IncorrectPathFailed.Create(path));
    }
}